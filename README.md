## domagate
#### Author: Timofeev Alexey, 2025
#### email: buzzin@mail.ru

Телеграм бот для работы с KVAS

### Модуль dg-main.py

#### Описание

Модуль предназначен для выполнения команд получаемых через мессенджер Telegram.
Запускается в docker контейнере и должен иметь сетевой достп для роутера на котором установлен KVAS.
Краткий алгоритм работы:

1. Запуск
2. Проверка новых сообщений в бесконечном цикле с задержкой setup.UPDATE_TIMER
3. При поступлении новых сообщений проверка отправителя на наличие в списке secret.USERS
4. Проверка сообщения на наличие известных команд:
/add - Добавление доменов в kvas
/del - Удаление доменов из kvas
/status - Статус роутера (не реализвано до конца)
/reply - Запрос ответа
5. Запуск команды /add <domain1> [domain2 ...]
    Для каждого домена производится:
    Удаление из имени домена всех символов кроме букв, цифт и знака точки
    Создание SSH сессии на роутер 
    Выполнение команды "kvas add <domain> -y"
    Возращает stdout и stderr
    Отправляет ответ в телеграм (прикладывает stdout и stderr)
6. Запуск команды /del <domain1> [domain2 ...]
    Аналогично команде /add, только удаляет домен из kvas
7. Запуск команды /status
    Создает SSH сессию на роутер, выполняет "ls -la /" и возвращает stdout и stderr
8. Запуск команды /reply
    Отвечает с сообщением "Hello. It\'s {secret.BOT_NAME}. I\'m alive!"

Ответ от бота приходит в туда, откуда был отправлена команда (личные сообщения или канал)

#### Настройка

    cd /opt/
    git clone
    cd /opt/UsynoviteP
    mkdir logs
    mkdir data
    touch secret.py

#### Отредактировать файл secret.py

    chat_id = "XXX"   #ID чата в который будут отсылаться анкеты         
    token = "YYY"     #ID бота в Telegram
    
#### Создание образа docker
    
    docker build -t domagate .
   
#### Запуск образа

    docker run -d --restart=always -v /opt/domagate:/app domagate:latest