## domagate
#### Author: Timofeev Alexey, 2025
#### email: buzzin@mail.ru

Телеграм бот для работы с KVAS

### Модуль dg-main.py

#### Описание

Модуль предназначен для выполнения команд получаемых через мессенджер Telegram.
Запускается в docker контейнере и должен иметь сетевой доступ до роутера на котором установлен KVAS.<br>
Краткий алгоритм работы:

1. Запуск<br>
2. Проверка новых сообщений в бесконечном цикле с задержкой setup.UPDATE_TIMER
3. При поступлении новых сообщений проверка отправителя на наличие в списке secret.USERS
4. Проверка сообщения на наличие известных команд:<br>
/add - Добавление доменов в kvas<br>
/del - Удаление доменов из kvas<br>
/status - Статус роутера (не реализовано до конца)<br>
/reply - ping
5. Запуск команды /add <domain1> [domain2 ...]<br>
    Для каждого домена производится:<br>
    Удаление из имени домена всех символов кроме букв, цифт и знака точки<br>
    Создание SSH сессии на роутер <br>
    Выполнение команды "kvas add <domain> -y"<br>
    Возращает stdout и stderr<br>
    Отправляет ответ в телеграм (прикладывает stdout и stderr)<br>
6. Запуск команды /del <domain1> [domain2 ...]<br>
    Аналогично команде /add, только удаляет домен из kvas
7. Запуск команды /status<br>
    Создает SSH сессию на роутер, выполняет "ls -la /" и возвращает stdout и stderr
8. Запуск команды /reply<br>
    Отвечает с сообщением "Hello. It\'s {secret.BOT_NAME}. I\'m alive!"

Ответ от бота приходит туда, откуда был отправлена команда (личные сообщения или канал)

#### Настройка

1. Клонировать репозиторий в /opt
2. Скопировать файл secret.template.py в secret.py
3. Отредактировать файл secret.py
4. Проверить настройки в setup.py
5. Создать образ docker командой: docker build -t domagate .
6. Запустить образ: docker run -d --restart=always -v /opt/domagate:/app domagate:latest